---
title: "R Notebook"
author: "Jason P. Casey"
date: 2018-11-20
output: html_notebook
---

# Read Crosswalk

```{r setup}
knitr::opts_chunk$set(fig.width = 8,
                      fig.asp = 0.618,
                      echo = TRUE)
knitr::knit_engines$set(python = reticulate::eng_python)

# include user functions
library(DBI)
library(odbc)
library(readxl)
library(tidyverse)

read_db <- function(db, query_string)
{
  # Open a connection
  connection <- dbConnect(odbc::odbc(), db)
  
  response <- dbSendQuery(connection, query_string)
  tbl <- dbFetch(response)
  dbClearResult(response)
  
  # disconnect from the database
  dbDisconnect(connection)
  
  return(as_tibble(tbl))
}

write_db <- function(frame, db, tab, add = TRUE) {
  con <- dbConnect(odbc::odbc(), db)
  
  answer <- system.time({ dbWriteTable(con,
                                       tab,
                                       frame,
                                       overwrite=!add,
                                       append = add
                                       ) })
  
  dbDisconnect(con)
  
  return(answer)
}

xwalk <- read_db("cdw", "SELECT * FROM extract.NsfIpedsBridge")
institutions <- read_db("cdw", "SELECT * FROM dbo.institutions")

```

# Read Base Data

```{r}
herd_meta <- tibble(year = 2010:2017)

for (i in seq_along(herd_meta$year)) {
  herd_meta <-
    herd_meta %>%
    mutate(path = str_c("https://www.nsf.gov/statistics/herd/data/csv/herd_", year, ".csv"),
           file = str_c("../../data/herd/herd_", year, ".xlsx"),
           data = map(file, read_excel)
           )
}

herd_meta

```

# Make HERD Data File

```{r}
herd <- herd_meta %>%
  select(data) %>%
  unnest() %>%
  mutate(inst_id = as.integer(inst_id)) %>%
  inner_join(xwalk, by = c("inst_id" = "NsfSurveyId")) %>%
  # filter(data > 0) %>%
  mutate(year_id = as.integer(year),
         unitid = as.integer(ipeds_unitid),
         unitid = ifelse(is.na(unitid), as.integer(RollupId), as.integer(unitid)),
         hbcu_flag = as.integer(hbcu_flag),
         med_sch_flag = as.integer(as.logical(med_sch_flag)),
         hhe_flag = as.integer(hhe_flag),
         toi_code = as.integer(toi_code),
         hdg_code = as.integer(hdg_code),
         tod_code = as.integer(toc_code)) %>%
  select(inst_id, ncses_inst_id, unitid, unitid_xwalk = Unitid, year_id, hbcu_flag:column, tod_code, data)

rm(herd_meta)

herd
```

# Write Raw HERD Data to Database

```{r}
system.time({
  herd %>%
    write_db("cdw", "raw_herd", add = FALSE)
})
```

# Read HERD Table into Memory

```{r}
system.time({
  herd <- read_db("cdw", "SELECT * FROM [dbo].[raw_herd]")
})
```

# Inspect Contents of HERD Table

```{r}
herd %>%
  count(questionnaire_no, question, row, column)
```

# Check Institution Codes

```{r}
unique <- herd %>%
  group_by(unitid, inst_id, ncses_inst_id, unitid_xwalk, med_sch_flag) %>%
  summarise(last_year_reported = max(year_id)) %>%
  ungroup()

mismatch <- unique %>%
  # filter(last_year_reported == 2017) %>%
  anti_join(institutions)

mismatch 
# 
# %>%
#   inner_join(herd, by="inst_id")


```

# Institution Level Data Table

```{r}
fix_null <- function(x) {
  ifelse(is.na(x), 0, x)
}

inst_data <- herd %>%
  filter(questionnaire_no %in% c("01.a", "01.b", "01.c", "01.d", "01.e", "01.f", "01.g",
                                 "04")) %>%
  select(inst_id:inst_zip, questionnaire_no, data) %>%
  mutate(data = data * 1000) %>%
  spread(key = "questionnaire_no", value = "data") %>%
  mutate(federal_government = fix_null(`01.a`),
         state_and_local_government = fix_null(`01.b`),
         business = fix_null(`01.c`),
         nonprofit_organizations = fix_null(`01.d`),
         institutional_funds = fix_null(`01.e`),
         other_sources = fix_null(`01.f`),
         total_rd_expenses = fix_null(`01.g`),
         medical_school_expenses = fix_null(`04`),
         non_medical_rd = total_rd_expenses - medical_school_expenses) %>%
  select(inst_id:inst_zip, federal_government:non_medical_rd)

inst_data
```

# Detail Data Table

```{r}
herd_details <- herd %>%
  mutate(data = ifelse(is.na(data), 0, data * 1000)) %>%
  filter(column %in% c("DOD",
                       "DOE",
                       "HHS",
                       "NASA",
                       "NSF",
                       "USDA",
                       "Other agencies",
                       "State and local government",
                       "Business",
                       "Institution funds",
                       "Nonprofit organziations")) %>%
  separate(questionnaire_no, c("rownum","academic_field_id"), 2) %>%
  filter(as.integer(rownum) %in% c(9, 11),
         academic_field_id %in% c('A','B01','B02','B03','B04','B05','B06','B07','B08',
                                  'B09','C01','C02','C03','C04','D01','D02','D03','D04',
                                  'D05','E','F01','F02','F03','F04','F05','G','H01',
                                  'H02','H03','H04','H05','I','J01','J02','J03','J04',
                                  'J05','J06','J07','J08')) %>%
  mutate(funding_type = recode(as.integer(rownum),
                `9`="Federal",
                `11`="Non-federal")) %>%
  select(inst_id, unitid, ncses_inst_id, year_id, funding_type, agency_id = column, academic_field_id, expenditure = data)  # %>%
  # group_by(inst_id, unitid, ncses_inst_id, year_id, funding_type, agency_id, academic_field_id) %>%
  # summarise(expenditure = sum(expenditure, na.rm = TRUE)) %>%
  # ungroup()

herd_details
```

# Write Matched Records to Database

```{r}
system.time({
  unique %>%
    select(inst_id:inst_zip, last_reported_year_id = last_year_reported) %>%
    write_db("cdw", "nsf_bridge", add = FALSE)
})
```

# Write Institution Data

```{r}
system.time({
  inst_data %>%
    write_db("cdw", "nsf_herd_institution_data", add = TRUE)
})
```

# Write Detail Data

```{r}
system.time({
  herd_details %>%
    write_db("cdw", "nsf_herd_detail_data", add = TRUE)
})
```


